name: build-android-apk

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      artifact-name:
        value: ${{ jobs.build.outputs.artifact-name }}

jobs:
  build:
    runs-on: windows-latest
    outputs:
      artifact-name: android-apk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.35.3
          cache: true

      - name: Setup Java (Android)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          
      - name: Restore keystore
        shell: bash
        run: |
          echo "Secret length of ANDROID_KEY_PROPERTIES_BASE64: ${#ANDROID_KEY_PROPERTIES_BASE64}"
          echo "Secret length of ANDROID_JKS_BASE64: ${#ANDROID_JKS_BASE64}"
          echo "$ANDROID_KEY_PROPERTIES_BASE64" | base64 --decode > android/key.properties
          echo "$ANDROID_JKS_BASE64" | base64 --decode > android/app/clipshare.jks
        env:
          ANDROID_KEY_PROPERTIES_BASE64: ${{ secrets.ANDROID_KEY_PROPERTIES_BASE64 }}
          ANDROID_JKS_BASE64: ${{ secrets.ANDROID_JKS_BASE64 }}

      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: C:\Android\android-sdk
          key: android-sdk-v1

      - name: Build APK
        shell: pwsh
        run: |
          cd scripts
          ./build_apk.bat
          cd ..

      - name: Prepare APK artifact
        shell: pwsh
        run: |
          $apkDir = "build/app/outputs/apk/release"
      
          if (-not (Test-Path $apkDir)) {
            Write-Error "APK directory not found: $apkDir"
            exit 1
          }
      
          $apks = Get-ChildItem $apkDir -Filter *.apk
      
          if (-not $apks -or $apks.Count -eq 0) {
            Write-Error "No APK found in $apkDir"
            exit 1
          }
      
          Write-Host "Found $($apks.Count) APK(s):"
          $apks | ForEach-Object {
            Write-Host " - $($_.Name)"
          }
      
          New-Item -ItemType Directory -Path upload -Force | Out-Null
      
          Copy-Item $apks.FullName upload/ -Force


      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: upload/*.apk
          overwrite: true
