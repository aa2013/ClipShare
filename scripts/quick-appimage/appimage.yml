# ClipShare AppImage 配置文件
# 参考: https://docs.appimage.org/packaging-guide/hosted-services/opensuse-build-service.html

app: clipshare

# 构建依赖包（这些包会被安装到构建环境，但不会被打包到 AppImage）
build:
  packages:
    # Flutter 构建依赖
    - curl
    - git
    - unzip
    - xz-utils
    - zip
    - libglu1-mesa
    - clang
    - cmake
    - ninja-build
    - pkg-config
    - libgtk-3-dev
    - liblzma-dev
    - libstdc++-12-dev
    - libayatana-appindicator3-dev
    - libnotify-dev
    - libxkbcommon-dev
    - libsecret-1-dev
    - libgdk-pixbuf-2.0-dev

# AppImage 原料（这些包会被提取到 AppDir 中）
# 注意：Flutter 应用通常通过源码编译，不使用二进制包
ingredients:
  # 这里不需要 ingredients，因为我们从源码构建

# 构建脚本
script:
  # 设置环境变量
  - export PATH="$PATH:$HOME/flutter/bin"
  - export FLUTTER_ROOT="$HOME/flutter"
  - export BUILD_SOURCE_DIR="$PWD"

  # 下载并安装 Flutter（如果不存在）
  - |
    if [ ! -d "$HOME/flutter" ]; then
      echo "下载 Flutter SDK..."
      git clone https://github.com/flutter/flutter.git -b stable --depth 1 $HOME/flutter
    fi

  # 获取依赖
  - echo "获取 Flutter 依赖..."
  - cd $BUILD_SOURCE_DIR
  - flutter pub get

  # 构建 Flutter Linux Release
  - echo "构建 Flutter Linux Release..."
  - flutter build linux --release

  # 准备 AppDir 目录
  - echo "准备 AppDir 目录..."
  - APPDIR="$BUILD_APPDIR"
  - BUILD_DIR="$BUILD_SOURCE_DIR/build/linux/x64/release"
  - BUNDLE_DIR="${BUILD_DIR}/bundle"

  # 创建目录结构
  - mkdir -p ${APPDIR}/usr/bin
  - mkdir -p ${APPDIR}/usr/lib
  - mkdir -p ${APPDIR}/usr/share/applications
  - mkdir -p ${APPDIR}/usr/share/icons/hicolor/256x256/apps
  - mkdir -p ${APPDIR}/usr/share/icons/hicolor/512x512/apps
  - mkdir -p ${APPDIR}/usr/share/clipshare

  # 复制可执行文件
  - echo "复制可执行文件..."
  - cp ${BUNDLE_DIR}/clipshare ${APPDIR}/usr/bin/clipshare
  - chmod +x ${APPDIR}/usr/bin/clipshare

   # 复制数据目录（Flutter 期望数据在相对于可执行文件的 data/ 目录下）
  - |
    if [ -d "${BUNDLE_DIR}/data" ]; then
      echo "复制数据目录..."
      cp -r ${BUNDLE_DIR}/data ${APPDIR}/usr/bin/
    fi

  # 复制库文件（Flutter 期望库在相对于可执行文件的 lib/ 目录下）
  - echo "复制库文件..."
  - |
    if [ -d "${BUNDLE_DIR}/lib" ]; then
      cp -r ${BUNDLE_DIR}/lib ${APPDIR}/usr/bin/
    fi

  # 复制 files 目录（如果存在）
  - |
    if [ -d "${BUNDLE_DIR}/files" ]; then
      echo "复制 files 目录..."
      cp -r ${BUNDLE_DIR}/files ${APPDIR}/usr/bin/
    fi

  # 创建 AppRun 脚本
  - echo "创建 AppRun 脚本..."
  - printf '#!/bin/bash\nSELF=$(readlink -f "$0")\nHERE=${SELF%%/*}\nexport PATH="${HERE}/usr/bin:${PATH}"\nexport LD_LIBRARY_PATH="${HERE}/usr/bin/lib:${LD_LIBRARY_PATH}"\nexec "${HERE}/usr/bin/clipshare" "$@"\n' > ${APPDIR}/AppRun
  - chmod +x ${APPDIR}/AppRun

  # 创建 .desktop 文件
  - echo "创建 .desktop 文件..."
  - printf '[Desktop Entry]\nType=Application\nName=ClipShare\nName[zh_CN]=ClipShare 剪贴板同步\nComment=Cross-platform clipboard synchronization tool\nComment[zh_CN]=跨平台剪贴板同步工具\nExec=clipshare\nIcon=clipshare\nTerminal=false\nCategories=Utility;\nStartupNotify=true\nKeywords=clipboard;sync;share;transfer;\n' > ${APPDIR}/ClipShare.desktop

  # 复制图标
  - echo "复制图标..."
  - |
    if [ -f "${BUILD_SOURCE_DIR}/assets/images/logo/logo.png" ]; then
      if command -v convert &> /dev/null; then
        convert ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png -resize 256x256 ${APPDIR}/clipshare.png
        convert ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png -resize 256x256 ${APPDIR}/ClipShare.png
        convert ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png -resize 256x256 ${APPDIR}/.DirIcon
        convert ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png -resize 256x256 ${APPDIR}/usr/share/icons/hicolor/256x256/apps/clipshare.png
        convert ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png -resize 512x512 ${APPDIR}/usr/share/icons/hicolor/512x512/apps/clipshare.png
      else
        cp ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png ${APPDIR}/clipshare.png
        cp ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png ${APPDIR}/ClipShare.png
        cp ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png ${APPDIR}/.DirIcon
        cp ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png ${APPDIR}/usr/share/icons/hicolor/256x256/apps/clipshare.png
      fi
    else
      echo "警告: 未找到图标文件 ${BUILD_SOURCE_DIR}/assets/images/logo/logo.png"
    fi
